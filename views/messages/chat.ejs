<div class="chat-container">
    <div class="chat-header">
        <a href="/messages" class="btn-back-chat">‚Üê</a>
        <div class="chat-user-info">
            <div class="chat-avatar">
                <%= otherUser.fullName.charAt(0).toUpperCase() %>
            </div>
            <div>
                <h2 class="chat-user-name">
                    <%= otherUser.fullName %>
                </h2>
                <p class="chat-username">@<%= otherUser.username %>
                </p>
            </div>
        </div>
    </div>

    <div class="messages-container" id="messagesContainer">
        <% if (messages.length===0) { %>
            <div class="no-messages">
                <p>No messages yet. Start the conversation!</p>
            </div>
            <% } else { %>
                <% messages.forEach(function(message) { %>
                    <div class="message <%= message.sender._id.toString() === currentUser._id.toString() ? 'sent' : 'received' %>"
                        data-message-id="<%= message._id %>">
                        <div class="message-bubble">
                            <p class="message-content">
                                <%= message.content %>
                            </p>
                            <div class="message-meta">
                                <span class="message-time">
                                    <%= new Date(message.createdAt).toLocaleTimeString('en-US', { hour: '2-digit' ,
                                        minute: '2-digit' }) %>
                                </span>
                                <% if (message.sender._id.toString()===currentUser._id.toString()) { %>
                                    <span class="message-status">
                                        <%= message.isRead ? '‚úì‚úì' : '‚úì' %>
                                    </span>
                                    <% } %>
                            </div>
                        </div>
                    </div>
                    <% }); %>
                        <% } %>
    </div>

    <form class="message-input-form" id="messageForm">
        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" required>
        <button type="submit" class="btn-send">
            <span class="send-icon">üì§</span>
        </button>
    </form>
</div>

<script>
    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const otherUserId = '<%= otherUser._id %>';
    const conversationId = '<%= conversationId %>';
    let lastMessageId = '<%= messages.length > 0 ? messages[messages.length - 1]._id : "null" %>';

    // Scroll to bottom
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    scrollToBottom();

    // Send message
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = messageInput.value.trim();

        if (!content) return;

        try {
            const response = await fetch(`/messages/send/${otherUserId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });

            const data = await response.json();

            if (data.success) {
                addMessageToUI(data.message, true);
                messageInput.value = '';
                lastMessageId = data.message._id;
                scrollToBottom();
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message');
        }
    });

    // Add message to UI
    function addMessageToUI(message, isSent) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        messageDiv.dataset.messageId = message._id;

        const time = new Date(message.createdAt).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageDiv.innerHTML = `
            <div class="message-bubble">
                <p class="message-content">${escapeHtml(message.content)}</p>
                <div class="message-meta">
                    <span class="message-time">${time}</span>
                    ${isSent ? '<span class="message-status">‚úì</span>' : ''}
                </div>
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Poll for new messages every 3 seconds
    setInterval(async () => {
        try {
            const response = await fetch(`/messages/new/${conversationId}/${lastMessageId}`);
            const data = await response.json();

            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    addMessageToUI(message, false);
                    lastMessageId = message._id;
                });
                scrollToBottom();
            }
        } catch (error) {
            console.error('Error fetching new messages:', error);
        }
    }, 3000);

    // Focus input on load
    messageInput.focus();
</script>

<style>
    .chat-container {
        max-width: 900px;
        margin: 0 auto;
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .chat-header {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-back-chat {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        text-decoration: none;
        border-radius: 50%;
        font-size: 1.5em;
        transition: all 0.3s ease;
    }

    .btn-back-chat:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .chat-user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .chat-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: 700;
    }

    .chat-user-name {
        margin: 0;
        font-size: 1.2em;
    }

    .chat-username {
        margin: 0;
        opacity: 0.9;
        font-size: 0.9em;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f5f5;
    }

    .no-messages {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .message {
        margin-bottom: 15px;
        display: flex;
    }

    .message.sent {
        justify-content: flex-end;
    }

    .message.received {
        justify-content: flex-start;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
    }

    .message.sent .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.received .message-bubble {
        background: white;
        color: #333;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .message-content {
        margin: 0 0 5px 0;
        line-height: 1.4;
    }
    .message-meta {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 5px;
        font-size: 0.75em;
        opacity: 0.8;
    }
    .message-time {
        font-size: 0.9em;
    }
    .message-status {
        color: #4CAF50;
    }
    .message-input-form {
        display: flex;
        gap: 10px;
        padding: 20px;
        background: white;
        border-top: 1px solid #e0e0e0;
    }
    #messageInput {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1em;
        outline: none;
        transition: all 0.3s ease;
    }
    #messageInput:focus {
        border-color: #667eea;
    }
    .btn-send {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    .btn-send:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .send-icon {
        font-size: 1.2em;
    }
    @media (max-width: 768px) {
        .chat-container {
            border-radius: 0;
            height: 100vh;
        }

        .message-bubble {
            max-width: 85%;
        }
    }
</style>